

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rol de Turnos Semanal</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: 'Segoe UI', sans-serif; background: #f3f6fa; margin:0; padding:0; }
h1 { text-align:center; background:#004080; color:white; padding:10px 0; margin:0; }
.main-container { display:flex; gap:20px; padding:20px; }
.users-panel { width:220px; background:#e1e9f5; border-radius:10px; padding:15px; box-shadow:0 2px 5px rgba(0,0,0,0.2); height:fit-content; }
.users-panel h2 { text-align:center; font-size:18px; margin-bottom:10px; }
.user-container { position: relative; display:flex; justify-content:space-between; align-items:center; padding-right:5px; }
.user { border-radius:8px; padding:8px; cursor:pointer; text-align:center; color:white; font-weight:600; transition: transform 0.2s; flex-grow:1; }
.user:hover { transform: scale(1.05); }
.counter { background:white; color:black; border-radius:50%; width:20px; height:20px; text-align:center; line-height:20px; font-size:12px; margin-left:5px; }
.delete-btn { background: rgba(255,255,255,0.7); border:none; border-radius:50%; width:18px; height:18px; cursor:pointer; font-weight:bold; color:#333; font-size:12px; line-height:16px; padding:0; margin-left:5px; }
select { width:100%; padding:5px; margin-top:5px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
button { margin-top:10px; padding:10px 20px; background:#004080; color:white; border:none; border-radius:8px; cursor:pointer; transition: background 0.3s; width:100%; }
button:hover { background:#0059b3; }
.schedule-container { flex-grow:1; background:white; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:10px; overflow-x:auto; }
table { border-collapse:collapse; width:100%; text-align:center; }
th, td { border:1px solid #ccc; padding:8px; font-size:14px; vertical-align:top; }
th { background:#dbe7ff; font-weight:bold; }
td.turno { background:#d8e4f8; font-weight:bold; width:120px; }
td.area { background:#f1f5fb; font-weight:600; width:100px; }
td.bloque { min-height:60px; cursor:pointer; transition: background 0.3s; }
td.bloque:hover { background:#f0f8ff; }
.usuarios-lista { display:flex; flex-direction:column; gap:3px; }
.asignado { border-radius:6px; color:white; padding:4px 6px; font-size:13px; font-weight:bold; cursor:pointer; user-select:none; text-align:center; }
.asignado .nombre { font-weight:bold; }
.asignado .subtitulo { font-size:11px; opacity:0.8; }


/* Contenedor elegante del subt√≠tulo */
.subtitulo-box {
  margin-top: 12px;
  text-align: center;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.3s ease;
}
.subtitulo-box.show {
  opacity: 1;
  transform: translateY(0);
}

/* Etiqueta flotante */
.subtitulo-label {
  display: block;
  font-size: 13px;
  color: #555;
  margin-bottom: 4px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Selector personalizado */
.subtitulo-select {
  width: 160px;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background-color: #fdfdfd;
  font-size: 14px;
  color: #333;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  transition: all 0.2s ease;
}
.subtitulo-select:hover {
  border-color: #888;
}
.subtitulo-select:focus {
  outline: none;
  border-color: #0078ff;
  box-shadow: 0 0 0 3px rgba(0,120,255,0.15);
}

/* Oculto por defecto */
.hidden {
  display: none;
}

/* Modal Mejorado */
.modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); transition: opacity 0.3s ease; }
.modal-content { background-color: #fff; margin: 10% auto; padding: 25px 20px; border-radius: 12px; width: 350px; max-width: 90%; box-shadow: 0 8px 25px rgba(0,0,0,0.3); text-align: center; transform: translateY(-50px); opacity: 0; transition: all 0.3s ease; }

.modal.show .modal-content { transform: translateY(0); opacity: 1; }
.close { color: #999; float: right; font-size: 22px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
.close:hover { color: #333; }
.modal-content h3 { margin-top:0; margin-bottom:15px; font-family:'Segoe UI',sans-serif; font-weight:600; color:#004080; }
.modal-content input[type="text"], .modal-content input[type="color"] { width:90%; padding:8px 10px; margin-bottom:15px; border-radius:8px; border:1px solid #ccc; font-size:14px; transition:border-color 0.2s; }
.modal-content input[type="text"]:focus { border-color:#004080; outline:none; box-shadow:0 0 5px rgba(0,64,128,0.3); }
.modal-btn { width:100%; padding:10px; background:#004080; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition: background 0.3s, transform 0.2s; }
.modal-btn:hover { background:#0059b3; transform: translateY(-2px); }

footer {
  width: 100%;
  background-color: #004080;
  color: white;
  text-align: center;
  padding: 12px 0;
  font-size: 14px;
  position: relative; /* puedes cambiar a fixed si quieres que siempre est√© visible */
  bottom: 0;
  position: fixed;
bottom: 0;
left: 0;
z-index: 100;


}
/* ===== Modal Fines de Semana ===== */
#weekend-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#weekend-modal.show {
  display: flex !important;  /* üîπ fuerza el uso de flex */
}

#weekend-modal .modal-content {
  background: #fff;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;        /* üîπ no crece m√°s del 80% del alto */
  overflow-y: auto;         /* üîπ agrega scroll si se llena */
  padding: 20px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
}

/* üîπ barra de scroll personalizada */
#weekend-modal .modal-content::-webkit-scrollbar {
  width: 8px;
}
#weekend-modal .modal-content::-webkit-scrollbar-thumb {
  background-color: #aaa;
  border-radius: 8px;
}

/* üîπ lista de usuarios */
#weekend-users-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 12px;
  justify-content: center;
}

#weekend-users-list .usuario {
  font-size: 14px;
  padding: 4px 8px;
  border-radius: 6px;
  color: #fff;
}

/* Modal de confirmaci√≥n de captura */
#confirm-capture-modal {
  z-index: 2000 !important; /* üîπ M√°s alto que cualquier otro modal */
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* oscurecer fondo */
  justify-content: center;
  align-items: center;
}

#confirm-capture-modal.show {
  display: flex;
}

#confirm-capture-modal .modal-content {
  background: white;
  border-radius: 12px;
  max-width: 400px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
}

.modal1 { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
  .modal1-content { background:#fff; margin:15% auto; padding:20px; border-radius:10px; width:300px; text-align:center; }
</style>
</style>
</head>
<body>
<h1>üìã Rol de Turno Semanal</h1>

<div class="main-container">
  <div class="users-panel">
    <h2>Usuarios</h2>
    <div id="users-list"></div>

    <div id="subtitulo-container" class="subtitulo-box hidden">
      <label for="subtitulo-selector" class="subtitulo-label">Modo de trabajo</label>
      <select id="subtitulo-selector" class="subtitulo-select">
        <option value="">‚Äî Ninguno ‚Äî</option>
        <option value="Central">Central</option>
        <option value="OnCall">OnCall</option>
        <option value="Remoto">Remoto</option>
      </select>
    </div>
    

    <hr>
    <button onclick="openModal()">‚ûï Agregar Usuario</button>
    <button onclick="clearSelection()">Deseleccionar</button>
    <button onclick="clearAll()">üßπ Limpiar todo</button>
    <button onclick="saveAsImage()">üíæ Guardar como imagen</button>
    <button onclick="exportUserSummary()">üìà Exportar resumen a Excel</button>
    <br>
    <br>
     <br>
    <br>
    <button onclick="openWeekendModal()">üåô Fines de semana</button>
  </div>

  <div class="schedule-container" id="schedule-container">
    <table>
      <thead>
        <tr>
          <th>Turno</th>
          <th>Week</th>
          <th>Lunes</th>
          <th>Martes</th>
          <th>Mi√©rcoles</th>
          <th>Jueves</th>
          <th>Viernes</th>
          <th>S√°bado</th>
          <th>Domingo</th>
        </tr>
      </thead>
      <tbody id="schedule-body"></tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>Agregar Usuario</h3>
    <input type="text" id="modal-username" placeholder="Nombre del usuario">
    <input type="color" id="modal-usercolor" value="#0074D9">
    <button class="modal-btn" onclick="saveModalUser()">Guardar</button>
  </div>
</div>
<!-- Modal fines de semana -->

<div id="weekend-modal" class="modal">
  <div class="modal-content" style="width: 1000px; max-width: 95%;">
    <span class="close" onclick="closeWeekendModal()">&times;</span>
    <h3>Fines de semana</h3>
    <div style="display:flex; gap:20px;">
      <!-- Panel de usuarios -->
      <div class="users-panel" style="width:200px;">
        <h4>Usuarios</h4>
        <div id="weekend-users-list"></div>
        <div id="weekend-subtitulo-container" class="subtitulo-box hidden">
          <label for="weekend-subtitulo-selector" class="subtitulo-label">Modo de trabajo</label>
          <select id="weekend-subtitulo-selector" class="subtitulo-select">
            <option value="">‚Äî Ninguno ‚Äî</option>
            <option value="Central">Central</option>
            <option value="OnCall">OnCall</option>
            <option value="Remoto">Remoto</option>
          </select>
        </div>
      </div>

      <!-- Tabla fines de semana -->
      <div id="weekend-container" style="flex-grow:1; overflow-x:auto;"></div>
    </div>
    
  </div>
</div>
<!-- Contenedor del subt√≠tulo y deselect -->
<div id="weekend-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeWeekendModal()">&times;</span>
    <h2>Fines de Semana</h2>

    <!-- Lista de usuarios -->
    <div id="weekend-users-list" style="display:flex; gap:5px; flex-wrap:wrap;"></div>

    <!-- Selector de Central/Remoto/OnCall y bot√≥n Deseleccionar -->
    <div id="weekend-subtitulo-container" class="hidden" style="margin-top:10px;">
      <select id="weekend-subtitulo-selector">
        <option value="">-- Seleccionar --</option>
        <option value="Central">Central</option>
        <option value="Remoto">Remoto</option>
        <option value="OnCall">OnCall</option>
      </select>
      <button id="weekend-deselect-btn">Deseleccionar</button>
    </div>

    <!-- Tabla de fines de semana -->
    <div id="weekend-container" style="margin-top:15px;"></div>
  </div>
</div>


<!-- Modal Confirmaci√≥n Captura -->
<div id="confirm-capture-modal" class="modal">
  <div class="modal-content" style="max-width: 400px; text-align:center;">
    <h3>‚ö†Ô∏è Confirmar Captura</h3>
    <p>¬øEst√°s seguro de capturar?<br>Si capturas, se borrar√°n los datos actuales.</p>
    <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
      <button id="cancel-capture-btn" class="modal-btn">Cancelar</button>
      <button id="accept-capture-btn" class="modal-btn">Aceptar</button>
    </div>
  </div>
</div>


<!-- Modal de alerta -->
<div id="alert-modal" class="modal">
  <div class="modal-content" style="width:300px; text-align:center;">
    <span class="close" onclick="closeAlertModal()">&times;</span>
    <h3>‚ö†Ô∏è Advertencia</h3>
    <p id="alert-message"></p>
    <button onclick="closeAlertModal()" class="modal-btn">Aceptar</button>
  </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div id="confirm-modal" class="modal1">
  <div class="modal1-content">
    <p id="confirm-message"></p>
    <div style="margin-top:15px;">
      <button id="confirm-cancel">Cancelar</button>
      <button id="confirm-ok">Aceptar</button>
    </div>
  </div>
</div>

<script>
  const turns = [
    { name: "1er Turno", time: "6:00 - 14:00" },
    { name: "2do Turno", time: "14:00 - 21:30" },
    { name: "3er Turno", time: "21:30 - 00:00" }
  ];
  const areas = ["FD","BD (FIS)", "BD (MMS)", "BD (UPS)", "BD (SAP)"];
  const tbody = document.getElementById("schedule-body");
  const usersList = document.getElementById("users-list");
  let selectedUser = null;
  let selectedColor = null;


  // ====== Cabecera de d√≠as con fechas ======
const dias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];

const today = new Date();
const primerDiaSemana = new Date(today);
primerDiaSemana.setDate(today.getDate() - today.getDay() + 1 + 7); // lunes de la pr√≥xima semana

dias.forEach((dia, i) => {
  const th = document.querySelector(`thead tr th:nth-child(${i + 3})`);
  const fecha = new Date(primerDiaSemana);
  fecha.setDate(primerDiaSemana.getDate() + i);

  const diaNumero = fecha.getDate();
  const mesNombre = meses[fecha.getMonth()];

  th.innerText = `${dia} ${diaNumero} ${mesNombre}`;
});


  
  // ====== Mostrar Week X en la columna Week ======
  const firstJan = new Date(today.getFullYear(),0,1);
const weekNum = Math.ceil((((today - firstJan) / 86400000) + firstJan.getDay() + 1)/7) + 1;
  const thWeek = document.querySelector("thead tr th:nth-child(2)"); // columna Week
  thWeek.innerText = `Week ${weekNum}`;
  thWeek.style.color = "#004080";
  thWeek.style.fontWeight = "bold";
  
  // ====== Crear tabla de turnos y √°reas ======
  turns.forEach(turn => {
    areas.forEach((area, index) => {
      const tr = document.createElement("tr");
  
      // Columna Turno
      if(index === 0){
        const tdTurno = document.createElement("td");
        tdTurno.className = "turno";
        tdTurno.rowSpan = areas.length;
        tdTurno.innerHTML = `${turn.name}<br><small>${turn.time}</small>`;
        tr.appendChild(tdTurno);
      }
  
      // Columna √Årea
      const tdArea = document.createElement("td");
      tdArea.className = "area";
      tdArea.innerText = area;
      tr.appendChild(tdArea);
  
      // Columnas de d√≠as
      for(let i=0; i<7; i++){
        const td = document.createElement("td");
        td.className = "bloque";
        const contenedor = document.createElement("div");
        contenedor.className = "usuarios-lista";
        td.appendChild(contenedor);
        td.onclick = () => assignUser(contenedor);
        tr.appendChild(td);
      }
  
      tbody.appendChild(tr);
    });
  });
  
  // ====== Persistencia ======
  function saveUsersToStorage(){
    const usuarios = Array.from(document.querySelectorAll('.user')).map(u=>({name:u.innerText,color:u.style.background}));
    localStorage.setItem('usuarios',JSON.stringify(usuarios));
  }
  
  function loadUsersFromStorage(){
    const data = JSON.parse(localStorage.getItem('usuarios')||'[]');
    data.forEach(u=>createUserElement(u.name,u.color));
  }
  
  function saveAssignmentsToStorage(){
    const assignments = [];
    document.querySelectorAll('.bloque').forEach(td=>{
      const usuarios = Array.from(td.querySelectorAll('.asignado')).map(span=>({
        name: span.querySelector('.nombre').innerText,
        color: span.style.background,
        subtitulo: span.querySelector('.subtitulo')?.innerText||""
      }));
      assignments.push(usuarios);
    });
    localStorage.setItem('asignaciones',JSON.stringify(assignments));
    updateCounters();
  }
  
  function loadAssignmentsFromStorage(){
    const assignments = JSON.parse(localStorage.getItem('asignaciones')||'[]');
    const bloques = document.querySelectorAll('.bloque');

    assignments.forEach((usuarios,i)=>{
      if(!bloques[i]) return; // ‚ö† ignora bloques que no existen

      const container = bloques[i].querySelector('.usuarios-lista');
      if(!container) return; // ‚ö† ignora si no encuentra el contenedor

      usuarios.forEach(u=>{
        const span = document.createElement("span");
        span.className="asignado";
        span.style.background=u.color;

        const nombreDiv = document.createElement("div");
        nombreDiv.className="nombre";
        nombreDiv.innerText=u.name;
        span.appendChild(nombreDiv);

        if(u.subtitulo){
          const subDiv = document.createElement("div");
          subDiv.className="subtitulo";
          subDiv.innerText=u.subtitulo;
          span.appendChild(subDiv);
        }

        span.onclick=function(e){ 
          e.stopPropagation(); 
          if(confirm(`Eliminar a ${u.name}?`)){ 
            span.remove(); 
            saveAssignmentsToStorage(); 
          } 
        };

        container.appendChild(span);
      });
    });

    updateCounters();
}

  
  // ====== Usuarios ======
  function createUserElement(name,color){
    if(Array.from(document.querySelectorAll('.user')).some(u => u.innerText === name)) return;

    const container = document.createElement("div");
    container.className="user-container";
    const userDiv = document.createElement("div");
    userDiv.className="user";
    userDiv.style.background=color;
    userDiv.innerText=name;
    userDiv.onclick = ()=>selectUser(userDiv);
    enableUserColorChange(userDiv, name);

  
    const counter = document.createElement("div");
    counter.className="counter";
    counter.innerText="0";
  
    const delBtn = document.createElement("button");
    delBtn.className="delete-btn";
    delBtn.innerText="√ó";
    // Eliminar usuario en la lista principal
delBtn.onclick = (e) => {
  e.stopPropagation();
  if(confirm(`Eliminar usuario ${name}?`)){
    container.remove(); // quita de la UI
    // Eliminar asignaciones de ese usuario en la tabla
    document.querySelectorAll('.asignado .nombre').forEach(n => {
      if(n.innerText === name) n.parentElement.remove();
    });
    saveAssignmentsToStorage(); // actualizar asignaciones
    saveUsersToStorage();       // **guardar usuarios actualizados**
    if(selectedUser === name) clearSelection();
  }
};

  
    container.appendChild(userDiv);
    container.appendChild(counter);
    container.appendChild(delBtn);
    usersList.appendChild(container);
    saveUsersToStorage();
    updateCounters();
  }
  
// ====== Doble clic para cambiar color del usuario ======
function enableUserColorChange(userDiv, name) {
  userDiv.ondblclick = async (e) => {
    e.stopPropagation();
    // Crear input de color temporal
    const inputColor = document.createElement("input");
    inputColor.type = "color";
    inputColor.value = rgbToHex(userDiv.style.background);
    inputColor.style.position = "fixed";
    inputColor.style.left = "-9999px"; // fuera de la vista
    document.body.appendChild(inputColor);

    inputColor.onchange = () => {
      const newColor = inputColor.value;

      // Cambiar color del usuario en la lista
      userDiv.style.background = newColor;

      // Cambiar color de todas sus asignaciones en la tabla
      document.querySelectorAll(".asignado .nombre").forEach(n => {
        if (n.innerText === name) {
          n.parentElement.style.background = newColor;
        }
      });

      // Guardar cambios
      saveUsersToStorage();
      saveAssignmentsToStorage();
    };

    inputColor.click(); // abrir selector de color
    setTimeout(() => inputColor.remove(), 1000);
  };
}

// Funci√≥n auxiliar para convertir rgb() a hex
function rgbToHex(rgb) {
  if (!rgb) return "#0074D9";
  const res = rgb.match(/\d+/g);
  if (!res) return rgb;
  return "#" + res.slice(0, 3).map(x => {
    const hex = parseInt(x).toString(16);
    return hex.length === 1 ? "0" + hex : hex;
  }).join("");
}


//MODAL

function openModal() {
  const modal = document.getElementById("modal");
  const nameInput = document.getElementById("modal-username");
  const colorInput = document.getElementById("modal-usercolor");

  // üîπ Limpia los campos antes de abrir
  nameInput.value = "";
  colorInput.value = "#0074D9"; // color por defecto (puedes cambiarlo)

  modal.style.display = "block";
  setTimeout(() => modal.classList.add("show"), 10);
}


function closeModal() {
  const modal = document.getElementById("modal");
  modal.classList.remove('show');
  setTimeout(() => modal.style.display = 'none', 300);
}

function saveModalUser() {
  const name = document.getElementById('modal-username').value.trim();
  const color = document.getElementById('modal-usercolor').value;
  if (!name) return alert("Ingresa un nombre");
  createUserElement(name, color);
  closeModal(); // ‚úÖ funciona siempre
}

  
  // ====== Selecci√≥n ======
  function selectUser(el) {
    document.querySelectorAll('.user').forEach(u => u.style.outline = 'none');
    el.style.outline = '3px solid #000';
    selectedUser = el.innerText;
    selectedColor = el.style.background;
    
    const cont = document.getElementById('subtitulo-container');
    cont.classList.remove('hidden');
    setTimeout(() => cont.classList.add('show'), 10);
  }
  
  function clearSelection() {
    selectedUser = null;
    document.querySelectorAll('.user').forEach(u => u.style.outline = 'none');
    
    const cont = document.getElementById('subtitulo-container');
    cont.classList.remove('show');
    setTimeout(() => cont.classList.add('hidden'), 300);
  }
  
  // ====== Asignaci√≥n de usuarios ======
  function assignUser(container){
    if(!selectedUser) return;
    const yaAsignado = Array.from(container.children).some(u=>u.querySelector('.nombre')?.innerText===selectedUser);
    if(yaAsignado) return;
    const span = document.createElement("span");
    span.className="asignado";
    span.style.background=selectedColor;
    const nombreDiv = document.createElement("div");
    nombreDiv.className="nombre";
    nombreDiv.innerText=selectedUser;
    span.appendChild(nombreDiv);
    const subtitulo=document.getElementById('subtitulo-selector').value;
    if(subtitulo){
      const subDiv=document.createElement("div");
      subDiv.className="subtitulo";
      subDiv.innerText=subtitulo;
      span.appendChild(subDiv);
    }
    span.onclick=function(e){ e.stopPropagation(); if(confirm(`Eliminar a ${selectedUser}?`)){ span.remove(); saveAssignmentsToStorage(); } };
    container.appendChild(span);
    saveAssignmentsToStorage();
  }
  
  // ====== Contadores ======
function updateCounters(){
    const counts = {};
    document.querySelectorAll('.asignado .nombre').forEach(n => {
        counts[n.innerText] = (counts[n.innerText] || 0) + 1;
    });

    document.querySelectorAll('.user-container').forEach(c => {
        const userDiv = c.querySelector('.user');
        const counterDiv = c.querySelector('.counter');
        if (!userDiv || !counterDiv) return; // ‚ö† evita error
        const name = userDiv.innerText;
        counterDiv.innerText = counts[name] || 0;
    });
}


  
// Funciones para abrir/cerrar modal de confirmaci√≥n
function showConfirm(message, onConfirm) {
  const modal = document.getElementById("confirm-modal");
  document.getElementById("confirm-message").innerText = message;

  modal.style.display = "block";

  // Cancelar
  const btnCancel = document.getElementById("confirm-cancel");
  btnCancel.onclick = () => { modal.style.display = "none"; };

  // Aceptar
  const btnOk = document.getElementById("confirm-ok");
  btnOk.onclick = () => {
    modal.style.display = "none";
    onConfirm(); // Ejecuta la acci√≥n confirmada
  };
}

// ====== Limpiar calendario ======
function clearAll() {
  showConfirm("¬øSeguro que quieres limpiar todo el calendario?", () => {
    document.querySelectorAll('.usuarios-lista').forEach(c => c.innerHTML = ""); 
    saveAssignmentsToStorage(); 
  });
}
  
// Guardar imagen con verificaci√≥n de usuarios
function saveAsImage() {
  const schedule = document.getElementById("schedule-container");
  if (!schedule) {
    alert("No se encontr√≥ el contenedor del calendario.");
    return;
  }

  const anyUserAssigned = schedule.querySelectorAll(".asignado").length > 0;
  if (!anyUserAssigned) {
    showAlert("No hay usuarios asignados. Por favor asigna usuarios antes de capturar la imagen.");
    return;
  }

  html2canvas(schedule, {
    backgroundColor: '#ffffff',
    scale: 2,
    useCORS: true
  })
  .then(canvas => {
    canvas.toBlob(blob => {
      const link = document.createElement("a");
      const fecha = new Date().toISOString().slice(0,10);
      link.download = `rol_de_turnos_${fecha}.png`;
      link.href = URL.createObjectURL(blob);
      link.click();
      URL.revokeObjectURL(link.href);
    }, "image/png");
  })
  .catch(err => {
    console.error("Error al generar la imagen:", err);
    alert("Ocurri√≥ un error al generar la imagen.");
  });
}
//Guardar Excel
function exportUserSummary() {
  const tbodyRows = document.querySelectorAll("#schedule-body tr");
  const diasCabecera = Array.from(document.querySelectorAll("#schedule-container thead th"))
                            .slice(2) // Saltamos Turno y Week
                            .map(th => th.innerText);

  if (tbodyRows.length === 0) return alert("No hay datos en el calendario.");

  // Verificar si hay al menos un usuario asignado
  const anyUserAssigned = Array.from(tbodyRows).some(tr => 
    Array.from(tr.querySelectorAll(".bloque")).some(td => td.querySelector(".asignado"))
  );
if(!anyUserAssigned) return showAlert("No hay usuarios asignados en el calendario. Por favor asigna usuarios.");

  let csvContent = "";

  // Cabecera: Week en primer cuadrito
  const weekText = document.querySelector("#schedule-container thead th:nth-child(2)").innerText;
  csvContent += `"${weekText}","","${diasCabecera.join('","')}"\n`;

  const userCounts = {};

  tbodyRows.forEach((tr, trIndex) => {
    const turno = tr.querySelector(".turno") ? tr.querySelector(".turno").innerText.replace(/\n/g,' ') : "";
    const area = tr.querySelector(".area") ? tr.querySelector(".area").innerText : "";

    const diasData = Array.from(tr.querySelectorAll(".bloque")).map(td => {
      // Tomamos el color de la celda para toda la columna
      const color = td.style.background || "#FFFFFF";
      const usuarios = Array.from(td.querySelectorAll(".asignado")).map(u => {
        const nombre = u.querySelector(".nombre")?.innerText || "";
        const subtitulo = u.querySelector(".subtitulo")?.innerText || "";
        if(nombre) userCounts[nombre] = (userCounts[nombre] || 0) + 1;
        return `${nombre}${subtitulo ? ` (${subtitulo})` : ""}`;
      }).join(", ");
      return `"${usuarios}"`; // usuarios dentro de la celda
    });

    csvContent += `"${turno}","${area}",${diasData.join(",")}\n`;
  });

  // L√≠nea vac√≠a
  csvContent += `\n`;

  // Resumen lateral
  csvContent += "Usuario,D√≠as Asignados\n";
  for(const [user, count] of Object.entries(userCounts)){
    csvContent += `"${user}",${count}\n`;
  }

  // Descargar CSV
  const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
  const link = document.createElement("a");
  const fecha = new Date().toISOString().slice(0,10);
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `Rol_Turno_${fecha}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}










function openWeekendModal() {
  const container = document.getElementById("weekend-container");
  container.innerHTML = "";
  const usersListContainer = document.getElementById("weekend-users-list");
  usersListContainer.innerHTML = "";

  // Clonar usuarios de la tabla principal
// Clonar usuarios de la tabla principal, pero sin contador ni bot√≥n de eliminar
document.querySelectorAll('.user-container').forEach(c => {
  const clone = c.cloneNode(true);
  const userDiv = clone.querySelector('.user');

  // Limpiar el container: quitar contador y delete-btn si exist√≠an
  const counter = clone.querySelector('.counter');
  if(counter) counter.remove();
  const delBtn = clone.querySelector('.delete-btn');
  if(delBtn) delBtn.remove();

  userDiv.onclick = () => selectWeekendUser(userDiv);
  usersListContainer.appendChild(clone);
});


  document.querySelectorAll('.user').forEach(u => u.style.outline = 'none');
  selectedWeekendUser = null;
  selectedWeekendColor = null;

  const diasIndices = [4,5,6]; // viernes, s√°bado, domingo
  const table = document.createElement("table");
  table.style.width = "100%";
  table.style.borderCollapse = "collapse";

// Cabecera
const thead = document.createElement("thead");
const trHead = document.createElement("tr");

// Columna Turno
const thTurno = document.createElement("th");
thTurno.innerText = "Turno";
trHead.appendChild(thTurno);

// Columna √Årea -> Week X
const today = new Date();
const firstJan = new Date(today.getFullYear(),0,1);
const weekNum = Math.ceil((((today - firstJan) / 86400000 + firstJan.getDay()+1)/7));
const thWeek = document.createElement("th");
thWeek.innerText = `Week ${weekNum}`;
trHead.appendChild(thWeek);


// === D√≠as fines de semana (semana actual) ===
const dias = ["Viernes", "S√°bado", "Domingo"];
const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];

const today1 = new Date();
// Calcula el viernes de la semana actual
const primerDiaSemana = new Date(today1);
primerDiaSemana.setDate(today1.getDate() - today1.getDay() + 5); // viernes de la semana actual

dias.forEach((dia, i) => {
  const fecha = new Date(primerDiaSemana);
  fecha.setDate(primerDiaSemana.getDate() + i);
  const th = document.createElement("th");
  th.innerText = `${dia} ${fecha.getDate()} ${meses[fecha.getMonth()]}`;
  trHead.appendChild(th);
});



thead.appendChild(trHead);
table.appendChild(thead);



  // Filas (por turno y √°rea)
  const turns = [
    { name: "1er Turno", time: "6:00 - 14:00" },
    { name: "2do Turno", time: "14:00 - 21:30" },
    { name: "3er Turno", time: "21:30 - 00:00" }
  ];
  const areas = ["FD","BD (FIS)", "BD (MMS)", "BD (UPS)", "BD (SAP)"];
  const tbody = document.createElement("tbody");

  turns.forEach(turn => {
    areas.forEach((area,index) => {
      const tr = document.createElement("tr");

      if(index === 0){
        const tdTurno = document.createElement("td");
        tdTurno.className = "turno";
        tdTurno.rowSpan = areas.length;
        tdTurno.innerHTML = `${turn.name}<br><small>${turn.time}</small>`;
        tr.appendChild(tdTurno);
      }

      const tdArea = document.createElement("td");
      tdArea.className = "area";
      tdArea.innerText = area;
      tr.appendChild(tdArea);

      for(let i=0; i<diasIndices.length; i++){
        const td = document.createElement("td");
        td.className = "bloque";
        td.style.minHeight = "60px";
        td.style.border = "1px solid #ccc";

        const contenedor = document.createElement("div");
        contenedor.className = "usuarios-lista";
        td.appendChild(contenedor);

        const filaOriginal = document.querySelectorAll("#schedule-body tr")[turns.indexOf(turn)*areas.length + index];
        if(filaOriginal){
          const bloqueOriginal = filaOriginal.querySelectorAll("td.bloque")[diasIndices[i]];
          if(bloqueOriginal){
            bloqueOriginal.querySelectorAll(".asignado").forEach(u => {
              contenedor.appendChild(u.cloneNode(true));
            });
          }
        }

        td.onclick = () => assignWeekendUser(contenedor);
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });
  });

  table.appendChild(tbody);
  container.appendChild(table);

// Crear contenedor de botones debajo de los usuarios (solo si no existe)
let buttonsContainer = document.getElementById("weekend-buttons-container");
if(!buttonsContainer){
  buttonsContainer = document.createElement("div");
  buttonsContainer.id = "weekend-buttons-container";
  buttonsContainer.style.marginTop = "10px";
  buttonsContainer.style.display = "flex";
  buttonsContainer.style.flexDirection = "column"; // esto pone los botones en columna (uno arriba del otro)
  buttonsContainer.style.gap = "10px"; // separaci√≥n vertical entre botones

  // Bot√≥n Capturar
  // Bot√≥n Capturar
const btnCapturar = document.createElement("button");
btnCapturar.innerText = "Capturar Imagen";
btnCapturar.onclick = () => openConfirmCaptureModal();
buttonsContainer.appendChild(btnCapturar);

// ===== Modal Confirmaci√≥n Captura =====
function openConfirmCaptureModal() {
  const modal = document.getElementById("confirm-capture-modal");
  modal.style.display = "block";
  setTimeout(() => modal.classList.add("show"), 10);

  const cancelBtn = document.getElementById("cancel-capture-btn");
  const acceptBtn = document.getElementById("accept-capture-btn");

  cancelBtn.onclick = () => closeConfirmCaptureModal();
  acceptBtn.onclick = () => {
    closeConfirmCaptureModal();
    captureWeekendTable(); // ‚úÖ guardar imagen
  };
}

function closeConfirmCaptureModal() {
  const modal = document.getElementById("confirm-capture-modal");
  modal.classList.remove("show");
  setTimeout(() => modal.style.display = "none", 300);
}


  // Bot√≥n Deseleccionar Usuario
  const btnDeseleccionar = document.createElement("button");
  btnDeseleccionar.innerText = "Deseleccionar Usuario";
  btnDeseleccionar.onclick = () => {
    selectedWeekendUser = null;
    selectedWeekendColor = null;
    document.querySelectorAll('#weekend-users-list .user').forEach(u => u.style.outline = 'none');
    const cont = document.getElementById('weekend-subtitulo-container');
    cont.classList.remove('show');
    setTimeout(() => cont.classList.add('hidden'), 300);
  };
  buttonsContainer.appendChild(btnDeseleccionar);

  // Agregar botones debajo de los usuarios
  usersListContainer.parentElement.appendChild(buttonsContainer);
}




// Mostrar modal de fines de semana
const modal = document.getElementById("weekend-modal");

// üßº Limpia el contenido anterior antes de mostrarlo
limpiarModalFinesDeSemana();

modal.style.display = "block";
setTimeout(() => modal.classList.add("show"), 10);

}
function limpiarModalFinesDeSemana() {
  const modal = document.getElementById("weekend-modal");
  if (!modal) return;
  modal.querySelectorAll(".asignado").forEach(celda => {
    celda.classList.remove("asignado");
    const nombre = celda.querySelector(".nombre");
    if (nombre) nombre.remove();
    celda.style.background = "";
  });
}


function closeWeekendModal() {
  const modal = document.getElementById("weekend-modal");
  modal.classList.remove("show");
  setTimeout(()=> modal.style.display="none", 300);
}

// Captura solo de la tabla y cierra modal despu√©s de confirmar
function captureWeekendTable() {
  const schedule = document.querySelector("#weekend-container table");
  if (!schedule) return alert("No se encontr√≥ la tabla.");

  html2canvas(schedule, { backgroundColor: '#fff', scale: 2, useCORS: true })
    .then(canvas => {
      canvas.toBlob(blob => {
        const link = document.createElement("a");
        link.download = "weekend_turnos.png";
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);
      }, "image/png");
    })
    .catch(err => {
      console.error(err);
      alert("Error al capturar la tabla");
    });

  // ‚ùå ya NO pongas confirmaciones aqu√≠
  // closeWeekendModal() solo si quieres cerrar autom√°ticamente despu√©s de guardar
  closeWeekendModal();
}

let selectedWeekendUser = null;
let selectedWeekendColor = null;

// Mostrar el contenedor cuando se selecciona un usuario
function selectWeekendUser(el){
  document.querySelectorAll('#weekend-users-list .user').forEach(u => u.style.outline='none');
  el.style.outline = '3px solid #000';
  selectedWeekendUser = el.innerText;
  selectedWeekendColor = el.style.background;

  // Mostrar selector y bot√≥n
  const cont = document.getElementById('weekend-subtitulo-container');
  cont.classList.remove('hidden');
  setTimeout(()=> cont.classList.add('show'), 10);
}

// Deseleccionar usuario
document.getElementById('weekend-deselect-btn').onclick = function(){
  selectedWeekendUser = null;
  selectedWeekendColor = null;
  document.querySelectorAll('#weekend-users-list .user').forEach(u => u.style.outline='none');

  const cont = document.getElementById('weekend-subtitulo-container');
  cont.classList.remove('show');
  setTimeout(()=> cont.classList.add('hidden'), 300);
};






// Asignar usuario a bloque
function assignWeekendUser(container){
  if(!selectedWeekendUser) return;

  const yaAsignado = Array.from(container.children).some(u => u.querySelector('.nombre')?.innerText===selectedWeekendUser);
  if(yaAsignado) return;

  const span = document.createElement("span");
  span.className = "asignado";
  span.style.background = selectedWeekendColor;

  const nombreDiv = document.createElement("div");
  nombreDiv.className = "nombre";
  nombreDiv.innerText = selectedWeekendUser;
  span.appendChild(nombreDiv);

  const subtitulo = document.getElementById('weekend-subtitulo-selector').value;
  if(subtitulo){
    const subDiv = document.createElement("div");
    subDiv.className = "subtitulo";
    subDiv.innerText = subtitulo;
    span.appendChild(subDiv);
  }

  span.onclick = function(e){
    e.stopPropagation();
    if(confirm(`Eliminar usuario`)){
      span.remove();
    }
  };

  container.appendChild(span);
}



function ajustarTamanoUsuarios() {
  const contenedor = document.getElementById("users");
  if (!contenedor) return; // üîπ evita el error si a√∫n no existe

  const usuarios = contenedor.querySelectorAll(".usuario");
  if (usuarios.length === 0) return;

  let tamano = 1;
  if (usuarios.length > 6 && usuarios.length <= 10) tamano = 0.9;
  else if (usuarios.length > 10 && usuarios.length <= 15) tamano = 0.8;
  else if (usuarios.length > 15 && usuarios.length <= 20) tamano = 0.7;
  else if (usuarios.length > 20) tamano = 0.6;

  usuarios.forEach(u => {
    u.style.transform = `scale(${tamano})`;
    u.style.transformOrigin = "top left";
    u.style.margin = "3px";
  });
}


// Llamar cada vez que se crea o elimina un usuario
const originalCreateUserElement = createUserElement;
createUserElement = function(name, color) {
  const userDiv = originalCreateUserElement(name, color);
  ajustarTamanoUsuarios();
  return userDiv;
};

const originalDeleteUser = deleteUser;
deleteUser = function(name) {
  originalDeleteUser(name);
  ajustarTamanoUsuarios();
};
function deleteUser(name) {
  const userElement = document.querySelector(`.usuario[data-name="${name}"]`);
  if (userElement) userElement.remove();

  // üîπ Elimina tambi√©n del localStorage si lo est√°s usando
  const users = JSON.parse(localStorage.getItem("usuarios") || "[]");
  const updated = users.filter(u => u.name !== name);
  localStorage.setItem("usuarios", JSON.stringify(updated));

  // üîπ Reajusta tama√±os
  ajustarTamanoUsuarios();

  console.log(`Usuario ${name} eliminado`);
}

// Ejecutar una vez al cargar
window.addEventListener("load", ajustarTamanoUsuarios);






  
  // ====== Inicializaci√≥n ======
  window.onload = () => {
    loadUsersFromStorage();
    loadAssignmentsFromStorage();
  };
  
  function showAlert(message) {
  const modal = document.getElementById("alert-modal");
  document.getElementById("alert-message").innerText = message;
  modal.style.display = 'block';
  setTimeout(()=> modal.classList.add('show'), 10);
}

function closeAlertModal() {
  const modal = document.getElementById("alert-modal");
  modal.classList.remove('show');
  setTimeout(()=> modal.style.display = 'none', 300);
}

</script>
<footer id="footer">
  üìÖ Rol de Turnos Semanal -  Derechos reservados @AMPUERO
</footer>
</body>
</html>
